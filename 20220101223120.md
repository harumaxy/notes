# Hasura GraphQL Engine

#hasura #graphql #postgres

Hasura が開発した、主にRDBからGraphql API を自動生成するツール

# 使い方

https://hasura.io/docs/latest/graphql/core/getting-started/docker-simple.

公式docのgetting-startedから、docker-compose.yamlをダウンロードして起動するだけ
- postgres
- hasura
のコンテナ定義を含む


# DBのtrace

既に作成してあるDBに接続して、graphql API化できる

- localhost:8080 からダッシュボードを開く
- Database > connect database
  - postgres://~~ 形式のurlで追加
  - docker-compose でやっている場合はサービス名ホストで接続可能
    - この形式は psql でlogin or スクリプトを読ませて実行するのにも使える(メイン引数として)
- 追加したDB > schema を選択
- tableを選択 > trace
- graphql から利用できる

# Entities
HasuraからPostgresをlinkすると、接続したPostgresに様々な Entity が生成される

- public スキーマ
  - 様々な SQL Function
- hdb_catalog
  - hasura db に関する設定(リンクしているテーブル、クエリ、カスタムmutationクエリ、Rerationなど)


# Test The Graphql API
最初のタブ GraphiQL で色々試せる
Link, Trace したテーブルは自動でAPIが作成される

# example query
```
query {
  test(limit: 10, offset: 0){
    id,
    label,
    name
  }
}
```

mutation query おさらい
- mutation の中で関数コール
  - インサートする値などを JSON 形式で引数に渡す(今回は objects ラベル引数に配列で)
- 関数コール後のブロックの中身の `returning` フィールドの insert文の returing の値を入れる
```
mutation {
  insert_test(objects: [
    {
    	# id: 0, serial の数値を指定すると、DB側で serial 型にしていても自動でインクリメントされた新しい数値を割り当てなくなるので注意
      name: "from graphiql",
      label: "hello"
    }
  ]){
    returning {
      id
    }
  }
}
```

# DB page

- Browse Rows
- Insert Row
- Modify
  - ALTER TABLE 文をGUI実行する感じ
- Relationships
- Permission
  - Role, Policy

DB のテーブルを作成したり、データを Insert したり Update したり
いろいろ操作したりできる

DB のスキーマを操作した結果がマイグレーションファイルなどに記憶されるわけではないので、遊びでいじる以外の目的であればあんまりやる必要はない。
(migrationツールでDBを直接弄った後linkしたほうが良い)


# 対応DB
- Postgres
- BigQuery

使わなさそうなの : MS SQL Server, MySQL, Citus/Hyperscale


# 
