# Udemy : Prometheus + Grafana Hands on

#prometheus #grafana

HTTPS エンドポイントをスクレイプすることで監視する
ターゲットからmetrics を収集する
メトリクスベースの監視システム

監視できるもの
- performance
  - app
  - infra
- prometheus の測定基準を用いる

# 拡張性
Prometheus のコンポーネントはGoで記述される
静的バイナリとしてビルドとデプロイがかんたんらしい


# 多次元時系列DB

全ての時系列は metrics name と key value pair
label と呼ばれる

代表的なkey value
- method: get
- (key): (value)


# PromQL
- simpble
- read-only
- flexible
という特徴を持つクエリ言語

time series に格納されたどんなラベルのデータも集計できる

# 信頼性
分散システムに信頼を置かない思想なので、Prometheus 自体は単一ノードのシングルサーバー
分散ストレージに依存しない

# 歴史
2012年にスタート
CNCF (Cloud Native Computing Foundation) に 2016年に参加、k8s の次に登録されたプロジェクト
Apache 2.0 license
31k star

# Alternate Monitoring Tool
監視ツールの役目を再確認
あとprometheusの競合について知り、なぜprometheusを選ぶのかを理解する

- イベントを集めるor監視する (timestamp といっしょに)
- 効率的にストレージに保管する
- 検索、クエリ機能をサポート
- グラフィカルな監視(できれば)

graphite, influxdb, open_tsdb, nagios, sensu
これらの代替ツールは人気だが、prometheusに対してデメリットも有る

## vs Graphite
データの収集とグラフ化の機能を持つ

直接のデータ収集サポートを持たない
Carbon という daemon で補強する必要がある

Prometheus は初の包括的なツールを持ち、out of box で使えるメリットが有る

履歴データを長時間保存できるクラスター化されたソリューションではGraphiteを選ぶ余地がある
あと、fluentd, collectd, statd などのバッテリーをすでに使ってる場合など

ゼロから始める場合は prometheus 一択

## 他のツール
- influxDB: Graphite と同じことが言える(一部機能を別のツールで補う必要あり、prometheusは包括的)


# 基礎用語 in Prometheus

- Monitoring
  - target project で行われている活動を、プログラムや監視サービスを使って収集し、目標値に届いているかなどをチェックしたりする
    システマチックなプロセスのこと
- Alert
  - マシン用語的に、トリガーイベントのこと
  - Monitoring の副産物
  - Prometheus においては、 PromQL 形式で条件やルールを設定し、継続的に評価する(定期実行などで)

- AlertManager
  - Alert が発生した場合に何かしら対処をする必要がある場合、Prometheus それ自体はその行動を取る責任はない
  - Alert に対する処置を行うAlertManager というエンティティが必要
    - アラートのグループ化、重複排除、フィルターなど
    - 指定された通知をユーザーに送信(mail, slack, pagerduty)

  Prometheus -> AlertManager -> Something...

- Target
  - スクレイピングする対象
  - Linux マシンとか、独自のアプリケーションとか
  - Prometheus 自体を target にすることもある
- Instance
  - Prometheus 用語で、スクレイピングできるエンドポイントのこと
    - target と似た意味
    - 廃棄される単一プロセスに対応
- Job
  - スケーラビリティのために複製された target/instance の集まりのことを言う
  - クラウドネイティブ意識されてるので、サービスの水平スケールを考えているということ
- Sample
  - 時系列のある時点で取得されたメトリックの単一値

# Architecture
https://gyazo.com/b2e6ad65f1d4e98eb080bdaa4d9f14fe

構成

- Prometheus Server
  - 本体(更に3つに分かれる)
    - Retrieval : target からのスクレイプ担当
    - Storage : time series DB, 保存担当
    - HTTP Server : PromQL を受付け、でストレージから検索
    - 収集したデータを保存するディスク : Grafana とかからアクセスされるデータ

# Pull metrics
Prometheus は、集計データを投稿されるのを待つのではなく、自分から target に対して取りに行く pull のシステムを採用している。
アプリケーションにより多くの柔軟性を提供する

- Jobs / Exporters : Prometheus の HTTP over pull に対応するエンドポイントを持ち、メトリクスを集計させる
- Short-lived jobs (Pushgateway) : 生存期間の短いジョブは、pullされるまで生きてる保証がないので自分でmetricsをpushする
  - しかし、Prometheus は pull 方式なので、Pushgateway にpushしてキューイングさせたものをpullさせる(間接的な方法)

# Service Discovery

Prometheus が metrics をpullするtargetを探すためのコンポーネント
Kubernetes などでも サービスディスカバリーがある(Service)

## Prometheus にターゲットを認識させる方法
- ハードコーディング(Bad practice)
- Service Discovery : Job が増えても対応できる

# Metrics が pull された後に利用するコンポーネント
- Prometheus web UI : battery included で out of box で使える UI
- Grafana : サードパーティ. 独自にカスタムできるUI
- API Client

Prometheus Server > HTTP Server から REST で利用する

- AlertManager : Alert を push する

# Instrumentation

target となるアプリやサービスは、そのままで Prometheus から metrics を pull させることはできない。
サポートライブラリを利用して、Prometheus に metrics を提供する準備が必要

## サービスメッシュとの併用
Kubernentes の場合は Istio (+ Envoy)
AWS ECS の場合は AppMesh (+ Envoy)
を利用してサービスメッシュにメトリクスが集計されるので、アプリケーション側を対応させる必要はなさそう
(サービスメッシュに対してpullを行う)

# Prometheus.yml

Prometheus の設定は、起動時に yaml を渡して設定する(declaretive)
検索したり、公式サイトでバイナリをダウンロードするときに同梱されるファイルを参考に書く

公式サイトのサンプルは、targetが localhost:9090 つまり prometheus 自身を監視する設定になってる

# Prometheus Web UI

起動すると、9090 ポートでHTTPリクエストを受け付ける
ルートにアクセスすると`/graph`にリダイレクトし、Prometheus UI が使える
PromQL expression を入力して実行するとmetricsを読み取れる

# PromQL
- up(metric) : target, instance, job をリスト表示
  - スクレイプが成功した場合は 1 、そうでなければ 0
## PromQL Hint
Execute ボタンの横にあるプルダウンから、利用できるmetric名のリストが出てくる
以下を試すとおすすめ
- prometheus_http_requests_total

デフォルトテンプレートだと、go runtime のことや prometheus HTTP server に関するmetricが多い
# Prometheus web UI の画面
- Alerts
- Graph
- Status
  - Runtime & Build info
  - CLI Flags
  - Configuration : YAML
  - RUles : Alert のルール
  - Targets : metric を収集(pull)する対象
  - Service Discovery

# metric の形状
metric名{key=value}
の形




# 参考
https://qiita.com/Chanmoro/items/ac0eb1bf93760566b338

# Prometheus.yml

設定ファイルの中を見る
Prometheus に関する指示、設定を全て定義する

- global
  - scrape_interval, evaluation_interval
  - このブロックは上書きしないかぎり Prometheus instance (pullのtarget先のこと)全体に適用される
- alerting
  - AlertManagerに関する設定
  - デフォルトだとターゲットがコメントアウトされてるので役に立たない
  - 講義が進んだらAlertManagerも用意する
- rule_files
  - yaml で定義した rule (alertの条件)ファイルを渡す
  - array
- scrape_configs
  - metrics を scrape する target を設定するところ
  - 初期設定だと自分自身のlocalhost port がハードコーディングされている
  - job_name : job (target process) の名前
  - 設定してないが重要な項目もある
    - metrics_path : 初期値は `/metrics` . ターゲット先の HTTP server の /metrics パスにメトリクスをpullさせるAPIが実装されていることを期待している
    - schema : HTTP がデフォルト
