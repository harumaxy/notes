# Linux で動かしながら学ぶ TCP/IP ネットワーク入門

#linux #tcp/ip


# Environment

M1 macOS では virtual box, vmware が対応してないので、仮想マシンを立ち上げるのが難しい

- multipass
- docker

# Install Commands

```sh
sudo apt-get -y install bash coreutils grep iproute2 iputils-ping traceroute tcpdump bind9-dnsutils dnsmasq-base netcat-openbsd python3 curl wget iptables procps isc-dhcp-client
```

# TCP/IP

- TCP = Transmission Control Protocol. データ転送の保証をするプロトコル(ヘッダーなど)
- IP = Internet Protocol. LANでつながったRouterをHopしていき、宛先までデータを届けるプロトコル
- Node = Router or Host(Routerではないコンピュータ). 木の幹に例えられる
- Ethernet = 富士ゼロックスの商標. 有線LANの規格
  - 物理層
  - データリンク層
- ICMP = Internet Control Message Protocol
  - ping に使う(echo request / echo reply)
  - もしくはエラーの通知など
  - IPによって運ばれる
- プロトコルの組み合わせ
  - IP のヘッダーの最後はPayload = data
  - data に他のプロトコルのヘッダーから始まるバイト列を入れることで、プロトコルを組み合わせられる(TCP header => Protocol に使うプロトコルを書いておく)
- Network Interface = NICカード(LAN)、Wi-fiアンテナモジュールなど、コンピューターから外部のネットへの出入り口のデバイスのこと
  - 番号、ID、名前が振られる
- パケットキャプチャ、スニッフィング = tcpdump, 通信の監視のこと
- ブロードバンド = 現在主流の回線帯域。ナローバンドをわざわざ使っているところは、普及が遅れているか設備をケチっている
- ブロードバンドルーター






# Linux command

- ping [addr]
  - -c : count
  - rtt = Round Trip Time
- traceroute [addr]
  - ttl を 1,2,3...と増やしつつリクエストを投げていって、ICMP replyで帰ってきたrouter のIPアドレス情報をプリントしていくという仕組み
  - -n : アドレスの名前を解決しないで、IPアドレスをそのまま表示する(no-name)
  - -h : ホップ数 (ttl = time to live 回数)
  - -f : first ttl. これを設定した回のルーター情報からリストが始まる
- tcpdump [protocol]
  - -t : 時刻を省く
  - -n : IPアドレスを逆引きしない
  - -i any : すべてのNetwork Interfaceの入出力を監視

# インターネット = バケツリレー

- パケット道順 = 通過するルーター機器
- Route = どのルーターを通ったか
  - traceroute のリストの最初と最後以外は全部router

- 家のLANからグローバルネットへの出口
  - モバイル回線(スマホ)
  - ブロードバンド回線(Router, 光コンセントのOCU)

- routing table
  - router がパケットを投げる先の候補
  - default : IP ヘッダの宛先がテーブルに無いときに投げる宛先

# ip command 

```sh
ip route show
```

ルーティングテーブルを表示する
結果の見方

```
default via 192.168.64.1 dev enp0s1 proto dhcp src 192.168.64.2 metric 100 
172.17.0.0/16 dev docker0 proto kernel scope link src 172.17.0.1 linkdown
```
たくさん列があるが見るのは一部

- ルーティングエントリ = 行
  - 2大要素
  - dist = 最終目標アドレス
  - next Hop = 次に渡す宛先の候補

上の例だと
- default, 172.17.0.0./16 = next hop list
  - これら２つは、複数のIPをまとめた書き方である
    - default = 他の宛先に当てはまらないものすべて
    - x.x.x.x/16 = 32 ビット中、サブネットマスクされた下16ビットを無視し、上16ビットが一致する宛先の場合にここに送る(つまりサブネット)


# Routing

```sh
sudo ip netns exec router1 add route x.x.x.0/24 via y.y.y.y
```

あるネットワークアドレス向けのリクエストを、viaで指定したアドレスに経由するルーティングエントリーをルーティングテーブルに追加する

この時、ip link add で作ってある veth のペアは既にルーティングテーブルに追加されている
なので y.y.y.y はrouter2のveth IP アドレスを指定する
